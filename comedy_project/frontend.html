<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Comedy Stage (Audio)</title>
    <style>
        body { background-color: #1a1a1a; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; height: 100vh; margin: 0; }
        #stage { width: 80%; height: 60%; background-color: #2b2b2b; border-radius: 10px; padding: 20px; overflow-y: auto; margin-top: 20px; border: 1px solid #444; }
        .msg { margin: 10px 0; padding: 10px; border-radius: 5px; max-width: 70%; }
        .ai { background-color: #2e7d32; align-self: flex-start; }
        .user { background-color: #1565c0; align-self: flex-end; margin-left: auto; }
        #controls { margin-top: 20px; display: flex; gap: 10px; }
        button { padding: 15px 30px; font-size: 18px; border: none; border-radius: 30px; cursor: pointer; color: white; transition: 0.3s; }
        #micBtn { background-color: #d32f2f; }
        #micBtn.recording { background-color: #ffca28; color: black; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>
    <h1>ğŸ¤ Live Comedy Stage</h1>
    <div id="stage"></div>
    <div id="controls">
        <button id="micBtn" onclick="toggleMic()">ğŸ™ï¸ Mic Off</button>
    </div>

    <script>
        let socket;
        let mediaRecorder;
        let isRecording = false;

        // server.pyì˜ MEDIARECORDER_TIMESLICE_MS ì™€ ë°˜ë“œì‹œ ë™ì¼í•´ì•¼ í•¨
        const TIMESLICE_MS = 500;

        function connectWs() {
            // [ì¤‘ìš”] ë¸Œë¼ìš°ì € ì£¼ì†Œê°€ httpsì´ë©´ wss(ë³´ì•ˆ)ë¥¼, httpë©´ wsë¥¼ ìë™ìœ¼ë¡œ ì„ íƒ
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            console.log("Connecting to WebSocket:", wsUrl); 

            socket = new WebSocket(wsUrl);

            socket.onopen = () => {
                console.log("âœ… WebSocket Connected!");
                addMessage("System: Server connected ready.", 'ai');
            };

            socket.onmessage = function(event) {
                // AIì˜ ë©”ì‹œì§€ë¥¼ ì±„íŒ…ì°½ì— ì¶”ê°€
                addMessage(event.data, 'ai');
            };

            socket.onerror = (error) => {
                console.error("âŒ WebSocket Error:", error);
                addMessage("System: Connection Failed. Check console.", 'ai');
            };
            
            socket.onclose = () => {
                console.log("âš ï¸ WebSocket Disconnected");
            };
        }

        function addMessage(text, type) {
            const stage = document.getElementById('stage');
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerText = text;
            stage.appendChild(div);
            stage.scrollTop = stage.scrollHeight;
        }

        async function toggleMic() {
            const btn = document.getElementById('micBtn');
            if (!isRecording) {
                // ë§ˆì´í¬ ì¼œê¸°
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                    // Chrome ê¸°ì¤€: ë³´í†µ webm+opusê°€ ì§€ì›ë¨
                    const preferredMime = 'audio/webm;codecs=opus';
                    const mimeType = MediaRecorder.isTypeSupported(preferredMime) ? preferredMime : 'audio/webm';
                    mediaRecorder = new MediaRecorder(stream, { mimeType });
                    
                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0 && socket.readyState === WebSocket.OPEN) {
                            socket.send(event.data); // ì˜¤ë””ì˜¤ ë°ì´í„° ì „ì†¡
                        }
                    };

                    // 0.5ì´ˆë§ˆë‹¤ ë°ì´í„°ë¥¼ ì˜ë¼ì„œ ì„œë²„ë¡œ ë³´ëƒ„ (ë°˜ì‘ ì†ë„ ì¡°ì ˆ)
                    mediaRecorder.start(TIMESLICE_MS); 
                    
                    isRecording = true;
                    btn.innerText = "ğŸ§ Listening...";
                    btn.classList.add('recording');
                    addMessage("ğŸ¤ Microphone connected!", "user");
                } catch (err) {
                    alert("Error accessing microphone: " + err);
                }
            } else {
                // ë§ˆì´í¬ ë„ê¸°
                mediaRecorder.stop();
                isRecording = false;
                btn.innerText = "ğŸ™ï¸ Mic Off";
                btn.classList.remove('recording');
            }
        }

        connectWs();
    </script>
</body>
</html>